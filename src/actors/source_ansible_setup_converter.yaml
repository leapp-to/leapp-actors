---
tags:
  - inspect_machine
inputs:
    - name: source_ansible_setup
      type: AnsibleSetupModuleFacts
outputs:
  - name: hostnameinfo
    type: HostnameInfo
  - name: ip_list
    type: IPList
  - name: osversion
    type: OSVersion

description: |
  Process Ansible Facts (system information) for further usage

  Inputs:
    source_ansible_setup - Ansible Facts
  Outputs:
    hostnameinfo         - hostname
    ip_list              - list of IP addresses
    osversion            - information about Operating System

executor:
  type: python
  payload: |
    import json
    import sys
    import re
    facts = json.load(sys.stdin)["source_ansible_setup"]["ansible_facts"]
    interface_pattern = re.compile('^ansible_(wl|e(th|n|m))')
    ips = []
    for interface in facts.keys():
      if interface_pattern.search(interface):
        ipv4 = facts[interface].get("ipv4", {})
        if not isinstance(ipv4, list):
          ipv4 = (ipv4,)
        for item in ipv4:
          ip = item.get("address")
          if ip:
            ips.append(ip)
    result = {
      "ip_list": {"ips": ips},
      "hostnameinfo": {"hostname": facts["ansible_hostname"]},
      "osversion": {"name": facts["ansible_distribution"], "version": facts["ansible_distribution_version"]}}
    sys.stdout.write(json.dumps(result))
